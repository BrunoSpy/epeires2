<?php 
$this->headScript()->appendFile($this->basePath() . '/assets/js/categories.js');
?>

<div class="container-fluid">
	<div class="row-fluid">
		<div class="span12">
			<table class="table table-striped">
				<thead>
					<tr>
						<th>id</th>
						<th>Nom</th>
						<th>Nom court</th>
						<th>Couleur</th>
						<th>Compact</th>
						<th>Timeline</th>
						<th>Evts</th>
						<th>Modèles</th>
						<th>Champs</th>
						<th>Champ titre</th>
						<th>Rôles</th>
						<th><a href="#form-container" id="add-cat" data-toggle="modal" class="btn btn-mini">Ajouter</a></th>
					</tr>
				</thead>
				<tbody>
                                <?php 
                                foreach ($this->categories as $category){
                                    if(!$category->isSystem()){
					echo "<tr>";
					echo "<td>".$category->getId()."</td>";		
					echo "<td>".$category->getName()."</td>";
					echo "<td>".$category->getShortName()."</td>";
					echo "<td><span class=\"label\" style=\"background-color:".$category->getColor()."\">".$category->getColor()."</span></td>";
					echo '<td>'.($category->isCompactMode()?"<i class=\"icon-ok icon-grey\"></i>":"<i class=\"icon-remove icon-grey\"></i>").'</td>';
					echo '<td>'.($category->isTimeline()?"<i class=\"icon-ok icon-grey\"></i>":"<i class=\"icon-remove icon-grey\"></i>").'</td>';
					echo "<td>".$this->events[$category->getId()]."</td>";
					echo "<td>".$this->models[$category->getId()]."</td>";
					echo "<td>".$this->fields[$category->getId()]." <a class=\"mod_fields\" href=\"#fieldscontainer\" data-id=\"".$category->getId()."\" data-name=\"".$category->getName()."\" data-toggle=\"modal\"><i class=\"icon-list\"></i></a></td>";
					echo "<td>".($category->getFieldName()?$category->getFieldName()->getName():"Non spécifié")."</td>";
					echo "<td>";
					foreach ($category->getReadroles() as $role){
						echo $role->getName()."<br/>";
					}
					echo "</td>";
					echo "<td>";
                                                echo "<a title=\"Monter\" href=\"#\" class=\"up-category\" data-id=\"".$category->getId()."\"><span class=\"up-caret middle\"></span></a> ";
                                                echo "<a title=\"Descendre\" href=\"#\" class=\"down-category\" data-id=\"".$category->getId()."\"><span class=\"caret middle\"></span></a> ";
						echo "<a title=\"Modifier\" href=\"#form-container\" class=\"mod\" data-id=\"".$category->getId()."\" data-name=\"".$category->getName()."\" data-toggle=\"modal\"><i class=\"icon-pencil\"></i></a> ";
						echo "<a title=\"Supprimer\" href=\"#confirm-delete\" data-href=\"".$this->url('administration', array('controller' => 'categories', 'action' => 'delete'))."?id=".$category->getId()."\" class=\"delete\" data-id=\"".$category->getId()."\" data-name=\"".$category->getName()."\" data-toggle=\"modal\"><i class=\"icon-trash\"></i> </a>";
					echo "</td>";
					echo "</tr>";
					
						foreach ($this->subcategories[$category->getId()] as $subcategory){
							echo "<tr>";
							echo "<td>".$subcategory->getId()."</td>";
							echo "<td>  <i class=\"icon-chevron-right\"></i> ".$subcategory->getName()."</td>";
							echo "<td>".$subcategory->getShortName()."</td>";
							echo "<td><span class=\"label\" style=\"background-color:".$subcategory->getColor()."\">".$subcategory->getColor()."</span></td>";
							echo '<td>'.($subcategory->isCompactMode()?"<i class=\"icon-ok icon-grey\"></i>":"<i class=\"icon-remove icon-grey\"></i>").'</td>';
							echo '<td>'.($subcategory->isTimeline()?"<i class=\"icon-ok icon-grey\"></i>":"<i class=\"icon-remove icon-grey\"></i>").'</td>';
							echo "<td>".$this->events[$subcategory->getId()]."</td>";
							echo "<td>".$this->models[$subcategory->getId()].
									" <a href=\"#models-container\"
								 		class=\"models-list\" 
								 		data-id=\"".$subcategory->getId()."\"
										data-name=\"".$subcategory->getName()."\"
								 		data-toggle=\"modal\"
								 		data-href=\"".$this->url('administration', array('controller'=>'models', 'action'=>'list'), array('query'=>array('id'=>$subcategory->getId())))."\"><i class=\"icon-list\"></i></a>".
						 		"</td>";
							echo "<td>".$this->fields[$subcategory->getId()]." <a class=\"mod_fields\" href=\"#fieldscontainer\" data-id=\"".$subcategory->getId()."\" data-name=\"".$subcategory->getName()."\" data-toggle=\"modal\"><i class=\"icon-list\"></i></a></td>";
							echo "<td>".($subcategory->getFieldName()?$subcategory->getFieldName()->getName():"Non spécifié")."</td>";
							echo "<td>";
							foreach ($subcategory->getReadroles() as $role){
								echo $role->getName()."<br/>";
							}
							echo "</td>";
							echo "<td>";
                                                                echo "<a title=\"Monter\" href=\"#\" class=\"up-category\" data-id=\"".$subcategory->getId()."\"><span class=\"up-caret middle\"></span></a> ";
                                                                echo "<a title=\"Descendre\" href=\"#\" class=\"down-category\" data-id=\"".$subcategory->getId()."\"><span class=\"caret middle\"></span></a> ";
								echo "<a title=\"Modifier\" href=\"#form-container\" class=\"mod\" data-id=\"".$subcategory->getId()."\" data-name=\"".$subcategory->getName()."\" data-toggle=\"modal\"><i class=\"icon-pencil\"></i></a>  ";
								echo "<a title=\"Supprimer\" href=\"#confirm-delete\" data-href=\"".$this->url('administration', array('controller' => 'categories', 'action' => 'delete'))."?id=".$subcategory->getId()."\" class=\"delete\" data-id=\"".$category->getId()."\" data-name=\"".$subcategory->getName()."\" data-toggle=\"modal\"><i class=\"icon-trash\"></i> </a>";
							echo "</td>";
							echo "</tr>";
						}			
                                    }
                                }
				?>
				</tbody>
			</table>
		</div>
		
	</div>
	
</div>

<!-- -------------------- -->
<!-- Les fenêtres modales -->
<!-- -------------------- -->


<div class="modal hide fade" id="form-container">
	<div class="modal-header">
		<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
		<h3  id="form-title"></h3>
	</div>
	<div id="form"></div>
</div>

<div class="modal hide fade" id="fieldscontainer" style="width:auto;">
	<div class="modal-header">
		<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
		<h3  id="fields-title"></h3>
	</div>
	<form action="<?php echo $this->url('administration', array('controller' => 'fields', 'action'=>'save'));?>" method="POST" name="CustomField" id="CustomField">
	<div id="fields-table">
	</div>
	</form>
</div>

<div class="modal hide fade" id="confirm-delete">
	<div class="modal-header">
		<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
		<h3>Confirmer la suppression ?</h3>
	</div>
	<div class="modal-body">
		<p>Voulez-vous vraiment supprimer la catégorie <em><span id="cat_name"></span></em> ?</p>
		<p>Tous les évènements, modèles et champs personnalisés associés à cette catégorie seront supprimés.</p>
	</div>	
	<div class="modal-footer">
		<a class="btn btn-danger" id="delete-href">Confirmer</a>
		<a id="cancel-form" class="btn" href="#" data-dismiss="modal" aria-hidden="true">Annuler</a>
	</div>	
</div>

<div class="modal hide fade" id="confirm-delete-field">
	<div class="modal-header">
		<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
		<h3>Confirmer la suppression ?</h3>
	</div>
	<div class="modal-body">
		<p>Voulez-vous vraiment supprimer le champ <em><span id="field_name"></span></em> ?</p>
		<p>Toutes les valeurs associées à ce champ seront supprimées.</p>
	</div>	
	<div class="modal-footer">
		<a class="btn btn-danger" id="delete-field-href">Confirmer</a>
		<a id="cancel-delete-field" class="btn" href="#" data-dismiss="modal" aria-hidden="true">Annuler</a>
	</div>	
</div>

<?php echo $this->partial('models/modals.phtml') ?>

<?php $this->inlineScript()->captureStart(); ?>

categories('<?php echo $this->url('administration')?>');

<?php if (isset($this->messages['success'])) { ?>
	<?php foreach ($this->messages['success'] as $message) { ?>
		var n = noty({text:'<?php echo $message ?>', 
					type:'success',
					layout: 'bottomRight',});
	<?php }?>
<?php } ?>

<?php if (isset($this->messages['error'])) { ?>
	<?php foreach ($this->messages['error'] as $message) { ?>
		var n = noty({text:'<?php echo $message ?>', 
					type:'error',
					layout: 'bottomRight',});
	<?php }?>
<?php } ?>

<?php $this->inlineScript()->captureEnd(); ?>